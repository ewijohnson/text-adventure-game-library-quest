import sys
import random


class Room:

    def __init__(self, name):
        self.name = name
        self.directions = []
        self.items = []

    def add_directions(self, direction):
        self.directions.append(direction)

    def add_items(self, item):
        self.items.append(item)

    def entering(self):
        self.enter = True

    def leaving(self):
        self.enter = False

    def inRoom(self):
        return self.enter

    def getName(self):
        return self.name

    def move(self, loc_room):
        direction_input = input("\nEnter a direction <'north', 'east', 'south', 'west'>: ")
        move_list = ['north', 'east', 'south', 'west']
        if direction_input in move_list:
            direction_input_function(direction_input, loc_room)
        else:
            print("I didn't quite get that. Try again?")

    def whereCanIMove(self):
        print('\nYou can move the following directions:')
        if self.directions[0] != 'None':
            print('north')
        if self.directions[1] != 'None':
            print('east')
        if self.directions[2] != 'None':
            print('south')
        if self.directions[3] != 'None':
            print('west')
        if self.directions[4] != 'None':
            print('up')
        if self.directions[5] != 'None':
            print('down')


#This is a subclass of class Room, and it adds two additional parameters for moving up or down
class ElevatorRoom(Room):

    def move_floors(self, loc_room):
        direction_input = input("\nEnter a direction <'north', 'east', 'south', 'west', 'up', 'down'>: ")
        move_floors_list = ['north', 'east', 'south', 'west', 'up', 'down']
        if direction_input in move_floors_list:
            direction_input_function(direction_input, loc_room)
        else:
            print("I didn't quite get that. Try again?")


class Player:

    def __init__(self, name, stats, stamina, items):
        self.name = name
        self.stats = stats
        self.stealth = stats[0]
        self.magic = stats[1]
        self.bravery = stats[2]
        self.stamina = stamina
        self.items = []

    def getName(self):
        return self.name

    def getStealth(self):
        return self.stealth

    def getMagic(self):
        return self.magic

    def getBravery(self):
        return self.bravery

    def getStamina(self):
        return self.stamina

    def getItems(self):
        return self.items


class Patron:

    def __init__(self, stats, stamina):
        self.stats = stats
        self.stealth = stats[0]
        self.magic = stats[1]
        self.bravery = stats[2]
        self.stamina = stamina

    def getStealth(self):
        return self.stealth

    def getMagic(self):
        return self.magic

    def getBravery(self):
        return self.bravery

    def getStamina(self):
        return self.stamina


# This function reads in a text file to create all instances of Room and ElevatorRoom
def createRoomInstances(infile_locations, all_locations):
    text_roomCreation = infile_locations.readlines()
    for line in text_roomCreation:
        line = line.split()
        if line[2] == 'Room':
            sliced_line = line[3:]
            sliced_line = " ".join(sliced_line)
            instanceRoom = Room(sliced_line)
            all_locations.append(instanceRoom)
        elif line[2] == 'ElevatorRoom':
            sliced_line = line[3:]
            sliced_line = " ".join(sliced_line)
            instanceRoom = ElevatorRoom(sliced_line)
            all_locations.append(instanceRoom)


# This function takes the instances of Room and ElevatorRoom and appends adjacent Locations to it, allowing for
#   moving between the locations
def appendAdjacentRoomsToLocations(infile, all_locations):
    for location in all_locations:
        line = infile.readline()
        line = clean_rooms_file(line)
        loopFinalLocationAppend(line, location)


# This function cleans the lines that are read in through appendAdjacentRoomsToLocation function
def clean_rooms_file(line):
    line = line.split()
    line = line[2:]
    line = ' '.join(line)
    line = line.replace(',', '')
    line = line.split()
    return line


# This function loops through the rooms in each cleaned line and adds the directions to each class instance
def loopFinalLocationAppend(line, location):
    for rooms in line:
        if rooms != 'None':
            rooms = eval(rooms)
            location.add_directions(rooms)
        else:
            location.add_directions(rooms)


def introduction():
    print('This is the introduction!')


def characterInitialization():
    name_input = input('What is your name? ')
    role_input = input('Would you like to start the game with more stealth, magic, or bravery? ')
    if role_input == 'stealth':
        player = Player(name_input, [8, 5, 5], 8, [])
        return player
    elif role_input == 'magic':
        player = Player(name_input, [5, 8, 5], 8, [])
        return player
    elif role_input == 'bravery':
        player = Player(name_input, [5, 5, 8], 8, [])
        return player
    else:
        print('Excuse me? Please try that again.')
        characterInitialization()


def getLocation(place):
    currentLocation = place.getName()
    print(f'\nYou are currently in the {currentLocation}.')


def getLocationHelp():
    print("\nYou have a few options for actions.")
    print("Enter one of the following:")
    print("'move'\n'check items'\n'look around'\n'talk'\n'get item'\n'use item'\n'Where am I?'\n'Where can I move?'\n'quit'\n")


def direction_input_function(direction, loc_room_loc):
    direction_list = ['north', 'east', 'south', 'west', 'up', 'down']
    dir_num = direction_list.index(direction)
    change_location(dir_num, loc_room_loc)


def change_location(dir_index, loc_self):
    if loc_self.directions[dir_index] != 'None':
        loc_self.directions[dir_index].entering()
        getLocation(loc_self.directions[dir_index])
        loc_self.leaving()
        patron_num = random.randint(1, 20)
        if patron_num <= 15:
            patronEncounter()
    elif loc_self.directions[dir_index] == 'None':
        print("\nThat room doesn't exist. Try again.")


def encounter_sneak(rand_patron, player_stealth, patron_stealth):
    random_stealth = random.randint(0, 10)
    if player_stealth > patron_stealth:
        stealth_prob = player_stealth - patron_stealth
        if stealth_prob > random_stealth:
            print('\nYou successfully snuck away!')
            print("\nYour stealth level is now", update_sneak(1))
            return
        elif stealth_prob <= random_stealth:
            print("\nYou weren't stealthy enough!")
            print("Your stamina has decreased! It is now at ", update_stamina(-1), '\n')
            patronEncounterLoop(rand_patron)
    elif player_stealth <= patron_stealth:
        stealth_prob = 1
        if stealth_prob > random_stealth:
            print('\nYou successfully snuck away!')
            print("\nYour stealth level is now", update_sneak(1))
            return
        elif stealth_prob <= patron_stealth:
            print("\nYou weren't stealthy enough!")
            print("Your stamina has decreased! It is now at", update_stamina(-1), '\n')
            patronEncounterLoop(rand_patron)


def encounter_magic(rand_patron, player_magic, patron_magic):
    random_magic = random.randint(0, 10)
    if player_magic > patron_magic:
        magic_prob = player_magic - patron_magic
        if magic_prob > random_magic:
            print('\nYou successfully confused the patron!')
            print("\nYour magic level is now", update_magic(1))
            return
        elif magic_prob <= random_magic:
            print("\nYour magic didn't work!")
            print("Your stamina has decreased! It is now at ", update_stamina(-1), '\n')
            patronEncounterLoop(rand_patron)
    elif player_magic <= patron_magic:
        magic_prob = 1
        if magic_prob > random_magic:
            print('\nYou successfully confused the patron!')
            print("\nYour magic level is now", update_magic(1))
            return
        elif magic_prob <= patron_magic:
            print("\nYour magic didn't work!")
            print("Your stamina has decreased! It is now at ", update_stamina(-1), '\n')
            patronEncounterLoop(rand_patron)


def encounter_bravery(rand_patron, player_bravery, patron_bravery):
    random_bravery = random.randint(0, 10)
    if player_bravery > patron_bravery:
        bravery_prob = player_bravery - patron_bravery
        if bravery_prob > random_bravery:
            print('\nYou successfully helped the patron!')
            print("\nYour bravery level is now", update_bravery(1))
            return
        elif bravery_prob <= random_bravery:
            print("\nYou didn't help the patron!")
            print("Your stamina has decreased! It is now at ", update_stamina(-1), '\n')
            patronEncounterLoop(rand_patron)
    elif player_bravery <= patron_bravery:
        bravery_prob = 1
        if bravery_prob > random_bravery:
            print('\nYou successfully helped the patron!')
            print("\nYour bravery level is now", update_bravery(1))
            return
        elif bravery_prob <= patron_bravery:
            print("\nYou didn't help the patron!")
            print("Your stamina has decreased! It is now at ", update_stamina(-1), '\n')
            patronEncounterLoop(rand_patron)


def patronEncounter():
    saved_stamina = player.getStamina()
    patron_infile = open('patron_lines.txt', 'r')
    patron_text = patron_infile.readlines()
    patron_infile.close()
    rand_patron_line_num = random.randint(1, 40)
    rand_patron = Patron([random.randint(1, 10), random.randint(1, 10), random.randint(1, 10)], random.randint(10, 25))
    print('\nA library patron appears!')
    print(patron_text[rand_patron_line_num - 1])
    patronEncounterLoop(rand_patron)
    player.stamina = saved_stamina
    print("Your stamina is now at", update_stamina(1))


def patronEncounterLoop(rand_patron):
    encounter_input = input('What would you like to do? <"Sneak away", "Use magic", "Help patron"> ')
    if encounter_input[:5] == 'sneak':
        encounter_sneak(rand_patron, player.stealth, rand_patron.stealth)
        return
    elif encounter_input == 'use magic':
        encounter_magic(rand_patron, player.magic, rand_patron.magic)
        return
    elif encounter_input == 'help patron':
        encounter_bravery(rand_patron, player.bravery, rand_patron.bravery)
        return
    else:
        print("\nYou can't do that now. Try something else.\n")
        patronEncounterLoop(rand_patron)


def update_stamina(num):
    player.stamina += num
    if player.stamina == 0:
        print("You passed out from exhaustion! Better luck next time.")
        raise RuntimeError
    else:
        return player.getStamina()


def update_sneak(num):
    player.stealth += num
    return player.getStealth()


def update_magic(num):
    player.magic += num
    return player.getMagic()


def update_bravery(num):
    player.bravery += num
    return player.getBravery()


def initialization_answer(choice):
    if choice == 'y':
        main()
    elif choice == 'n':
        print('Try again next time!')
        sys.exit()
    else:
        opening_choice = input("I don't know what you want. Try again? Type 'yes' or 'no'. ")
        opening_choice = opening_choice[0].lower()
        initialization_answer(opening_choice)


def initialization():
    opening_choice = input("Would you like to enter the library? ")
    opening_choice = opening_choice[0].lower()
    initialization_answer(opening_choice)


def main():
    game = True
    loc = all_locations[0]
    loc.entering()
    getLocation(loc)
    while game is True:
        game_loop()


def game_loop():
    for loc in all_locations:
        try:
            while loc.inRoom() is True:
                query = input('\nWhat would you like to do? ')
                query = query.lower()
                query = query.strip('?')
                # the 'help' query will allow the player to see all possible actions
                if query == 'help':
                    getLocationHelp()
                elif query[:4] == 'move':
                    # This checks to see if the current room is subclass ElevatorRoom or class Room
                    if isinstance(loc, ElevatorRoom):
                        # if class ElevatorRoom, there are more movement options (up or down, additionally)
                        loc.move_floors(loc)
                        break
                    elif isinstance(loc, Room):
                        # if class is just Room, there are just the basic four movement options
                        loc.move(loc)
                        break
                # Where can I move?
                elif query[:13] == 'where can i m':
                    loc.whereCanIMove()
                elif query == 'check items':
                    print('check items')
                elif query == 'look around':
                    print('Describe the settings of the room')
                elif query == 'talk':
                    print('talk to someone in current location')
                elif query == 'get item':
                    print('get an item')
                elif query == 'use item':
                    print('use an item')
                elif query == 'where am i':
                    getLocation(loc)
                elif query == 'quit':
                    quitting_input = input("Are you sure? ")
                    if quitting_input[0].lower() == 'y':
                        print("\nThanks for playing!")
                        raise RuntimeError
                    elif quitting_input[0].lower() == 'n':
                        break
                    else:
                        print("I didn't understand you.")
                else:
                    print('Didn\'t think of that option yet. Nice.')
        except RuntimeError:
            sys.exit()
        except:
            pass


# This creates all instances of Room and ElevatorRoom
all_locations = []
infile_locations = open('create_all_rooms.txt', 'r')
createRoomInstances(infile_locations, all_locations)
infile_locations.close()

# This links adjacent Locations to each Location, allowing for movement
infile = open('adjacent_rooms_file.txt', 'r')
appendAdjacentRoomsToLocations(infile, all_locations)
infile.close()


introduction()
player = characterInitialization()
print("Welcome, " + player.getName() + ". " + "Your starting stats are: ")
print(f'Stealth: {player.getStealth()}, Magic: {player.getMagic()}, Bravery: {player.getBravery()}, Stamina: {player.getStamina()}')
initialization()
